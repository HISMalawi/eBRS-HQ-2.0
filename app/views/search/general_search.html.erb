<%=javascript_include_tag "datatables/prototype" %>
<%=javascript_include_tag "datatables/jquery.dataTables.min" %>
<%=javascript_include_tag "datatables/dataTables.bootstrap" %>
<%=javascript_include_tag "bootstrap/bootstrap.min" %>

<%= stylesheet_link_tag "datatables/jquery.dataTables.min" %>

<style>
    #form select{
        border-radius: 2px;
        background: white;
        padding: 2px;
        padding-left: 5px;padding-right: 15px;
    }
    #form .filters .input{
        border-radius: 2px;
        background: white;
        padding: 2px;
        padding-left: 5px;padding-right: 15px;
    }
    #form select:disabled,  input:disabled{
        background: ghostwhite !important;
        width: 12%;
        margin-right: 7px;
    }
    #form select:enabled,  input:enabled{
        background: white !important;
        width: 12%;
        margin-right: 7px;
    }
    #form .check{
        width: 10px !important;
        margin-right: 40px !important;
    }
    #form label{
        width: 8%;
    }

    th{
        background: lightsteelblue;
        color: black;
    }
</style>

<div class="panel panel-default">
  <div class="panel-heading" style="height: 50px;">
    <table style="width: 100%;">
      <tr>
        <td>
          <h3 style="padding-bottom: 15px;color:darkslategray; height: 40px;margin-top: 0px;">General Search</h3>
        </td>
        <td colspan="8" style="width: 60%;">
          <div class="pull-right" style="height: 40px; margin-top: 0px;">

          </div>
        </td>
      </tr>
    </table>
  </div>

<div class="hide-when-print" id="query_form_with_buttons">
  <form id="form" action="/search_cases">
  <input type="hidden" value="1" id="set_filter" name="set_filter">
  <div id="query_form_content">
    <fieldset class="collapsible collapsed filters">
      <div class="control-group"  style="padding-bottom: 10px;">
        <span class="control-label">Filters</span><br />
        <div class="controls form-inline ">

          <input onclick="check(this)" type="checkbox" class="input-small check" id="fsn" style="margin-right: 105px;">
          <label for="serial_num">Facility serial number</label>
          <input type="text" class="input-small"  id="serial_num" name="filter[serial_num]">

          <label for="ben">BEN</label>
          <input type="text" class="input-small"  id="ben" name="filter[ben]">

          <label for="brn">BRN</label>
          <input type="text" class="input-small"  id="brn" name="filter[brn]">
        </div>
      </div>

      <div class="control-group" style="padding-bottom: 10px;">
        <div class="controls form-inline ">
          <input onclick="check(this)" type="checkbox" class="input-small check" id="child_name" style="margin-right: 105px;">

          <label for="last_name">Last name</label>
          <input type="text" class="input-small"  id="last_name" name="filter[names][last_name]">
          <label for="first_name">First name</label>
          <input type="text" class="input-small" id="first_name" name="filter[names][first_name]">
          <label for="last_name">Middle</label>
          <input type="text" class="input-small"  id="middle_name" name="filter[names][middle_name]">
        </div>
      </div>
      <div class="control-group" style="padding-bottom: 10px;">
        <div class="controls form-inline ">
          <input onclick="check(this)" type="checkbox" class="input-small check" id="gender" style="margin-right: 105px;">

          <label for="last_name">Gender</label>
          <select type="text" class="input-small"  id="gender" name="filter[gender]">
            <option></option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>
        </div>
      </div>

      <div class="control-group" style="padding-bottom: 10px;">
        <div class="controls form-inline ">
          <input onclick="check(this)" type="checkbox" class="input-small check" id="status" style="margin-right: 105px;">

          <label for="last_name">Record status</label>
          <select type="text" class="input-small"  id="status" name="filter[status]">
            <option></option>
            <% Status.all.order('name').each do |s|%>
                <option value="<%= s.id%>"><%= s.name.titleize.gsub(/Hq/, 'HQ').gsub(/Dc/, 'DC').gsub(/Fc/, 'FC')%></option>
            <% end %>
          </select>
        </div>
      </div>

      <div class="control-group" style="padding-bottom: 10px;">
        <div class="controls form-inline ">
          <input onclick="check(this)" type="checkbox" class="input-small check" id="place" style="margin-right: 105px;">

          <label for="place">Place of birth</label>
          <select type="text" class="input-small"  id="place" name="filter[place]" onchange="showFields(this)">
            <option></option>
            <option>Home</option>
            <option>Hospital</option>
            <option>Other</option>
          </select>

          <label for="district_of_birth">District of birth</label>
          <select type="text" class="input-small"  id="district_of_birth" name="filter[district_of_birth]">
            <option></option>
            <% @districts.each do |d|%>
                <option value="<%= d.name%>"><%= d.name%></option>
            <% end %>
          </select>

          <label for="ta_of_birth" class=" place home">TA of birth</label>
          <select type="text" class="input-small  place home"  id="ta_of_birth" name="filter[ta_of_birth]">
            <option></option>
            <% @districts.each do |d|%>
                <option value="<%= d.id%>"><%= d.name%></option>
            <% end %>
          </select>

          <label for="village_of_birth" class=" place home">Village of birth</label>
          <select type="text" class="input-small place home"  id="village_of_birth" name="filter[village_of_birth]">
            <option></option>
            <% @districts.each do |d|%>
                <option value="<%= d.id%>"><%= d.name%></option>
            <% end %>
          </select>

          <label for="hospital_of_birth" class=" place hospital">Hospital of birth</label>
          <select type="text" class="input-small place hospital"  id="hospital_of_birth" name="filter[hospital_of_birth]">
            <option></option>
            <% @districts.each do |d|%>
                <option value="<%= d.id%>"><%= d.name%></option>
            <% end %>
          </select>

          <label for="other_birth_place" class=" place other">Specify other birth place</label>
          <input type="text" class="input-small place other"  id="other_birth_place" name="filter[other_birth_place]">
        </div>
      </div>
    </fieldset>
  </div>
  <div class="buttons">
    <a class="btn btn-success btn-sm" onmousedown="searchFields();" style="cursor: pointer;">Apply</a>
  </div>
</form>
</div>

<div style="width: 100%; margin: auto;margin-top: 12px; padding-top: 5px;border-top: 2px solid darkred">
  <table id="example" class="display" cellspacing="0" width="100%">
    <thead>
    <tr>
      <th style="text-align: left;">BEN</th>
      <th style="text-align: left;">Name</th>
      <th style="text-align: center; width:90px;">Birthdate</th>
      <th style="text-align: left;">Gender</th>
      <th style="text-align: left;">Mother's Name</th>
      <th style="text-align: left;">Father's Name</th>
      <th style="text-align: center;">Status</th>
      <th>&nbsp;
      </th>
    </tr>
    </thead>

    <tbody id="tbody">
    </tbody>
  </table>
</div>



  <%(@records || []).each do |record|
  %>
    <tr>
      <td style="text-align: left;width: 15%"><%= record['ben'] %>&nbsp;</td>
      <% if @records.length > 0 && @records[0]['brn'].present? %>
          <td style="text-align: left;width: 15%"><%= record['brn'] %>&nbsp;</td>
      <% end %>
      <td style="text-align: left;width: 15%"></td>
      <td style="text-align: center;width: 15%"><%= record['dob'] %></td>
      <td style="text-align: center;width: 3%"><%= record['gender'] %></td>
      <td style="text-align: center;width: 15%"><%= record['mother_name'] %></td>
      <td style="text-align: center;width: 15%"><%= record['father_name'] %></td>
      <td style="text-align: center;"><%= record['status'] %></td>
      <td>
        <table style="width: 100%; text-align: center; border-style: none;">
          <tr>
            <td class="act-btn">
              <button onclick="javascript:location='/show_person/<%= record['id']%>'"
                      class="action-btn btn btn-success btn-xs"><i class="fa fa-eye"></i></button>
            </td>
            <%if admin?%>
                <td class="act-btn">
                  <button onclick="javascript:location='/edit/<%= record['person_id']%>'"
                          class=" hidden action-btn btn btn-primary btn-xs"><i class="fa fa-pencil"></i></button>
                </td>
                <td class="act-btn">
                  <button onclick="javascript:location='/void/<%= record['id']%>'"
                          class="action-btn btn btn-danger btn-xs"><i class="fa fa-trash-o"></i></button>
                </td>
            <%end%>

            <%if (['HQ-CAN-PRINT', 'HQ-CAN-REPRINT', 'HQ-PRINTED'] & params['statuses']).length > 0%>
                <td class="act-btn">
                  <div class="checkbox">
                    <label><input class='multi-check' person_id = "<%= record['id']%>" onchange="checkSelections();" type="checkbox" value=""></label>
                  </div>
                </td>
            <% end %>
          </tr>
        </table>
      </td>
    </tr>
<%end%>


<script type="text/javascript">
  jQuery(".filters input, .filters select").attr('disabled', true).val('');
  jQuery(".check").attr('disabled', false).val('');
  jQuery(".home, .hospital, .other").hide().val('');

  selected = [];
  table = null;

  $i(document).ready(function() {
     table = $i('#example').DataTable();
  } );

  function check(node){
      var nodes = jQuery(node).parent().children();

      if(jQuery(node).is(':checked')){
        nodes.attr('disabled', false)
      }else{
        nodes.attr('disabled', true).val('')
      }

      jQuery(node).attr('disabled', false)
  }
  function loadData(data){
    var row = document.createElement('tr');
    __$('tbody').appendChild(row);
    var td = document.createElement('td');
    td.className = 'table-cell'
    td.style.textAlign = 'center';
    td.innerHTML = data['ben'];
    row.appendChild(td);

    var td = document.createElement('td');
    td.className = 'table-cell'
    td.style.textAlign = 'center';
    td.innerHTML = data['name'];
    row.appendChild(td);

      var td = document.createElement('td');
      td.className = 'table-cell'
      td.style.textAlign = 'center';
      td.innerHTML = data['dob'];
      row.appendChild(td);

      var td = document.createElement('td');
      td.className = 'table-cell'
      td.style.textAlign = 'center';
      td.innerHTML = data['gender'];
      row.appendChild(td);

      var td = document.createElement('td');
      td.className = 'table-cell'
      td.style.textAlign = 'center';
      td.innerHTML = data['mother_name'];
      row.appendChild(td);

      var td = document.createElement('td');
      td.className = 'table-cell'
      td.style.textAlign = 'center';
      td.innerHTML = data['father_name'];
      row.appendChild(td);

      var td = document.createElement('td');
      td.className = 'table-cell'
      td.style.textAlign = 'center';
      td.innerHTML = data['status'];
      row.appendChild(td);
  }

  function showFields(select){
    var clas = select.value.toLowerCase();
    jQuery(".place").hide().val('');
    jQuery("." + clas).show().val('');
  }

  function searchFields(){
       jQuery("#tbody").empty();
       table.clear();

      jQuery.ajax({
          type: "POST",
          url: '/search_cases',
          data: jQuery("#form").serialize(),
          success: function(data)
          {
              data = JSON.parse(data);
              var arr = [];
              for (var i = 0; i < data.length; i++){
                 table.row.add([data[i]['ben'], data[i]['name'], data[i]['dob'],
                      data[i]['gender'], data[i]['mother_name'],
                     data[i]['father_name'], data[i]['status'], ''])
                  table.draw();
              }

          },
          error: function(e){
              console.log(e);
          }
      });
  }

    function capitalize(string){
        string = string.replace(/\_/g, ' ');
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function __$(id){
        return document.getElementById(id);
    }

</script>
